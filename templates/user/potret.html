<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absensi Wajah</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0; padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: #f5f5f5; color: #333;
      min-height: 100vh; display: flex;
      align-items: center; justify-content: center;
      padding: 20px;
    }
    .container {
      background: #fff; padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      width: 100%; max-width: 450px;
      border: 1px solid #ddd;
    }
    h2 {
      font-size: 26px; font-weight: 600;
      margin-bottom: 30px; display: flex;
      align-items: center; justify-content: center;
      gap: 10px;
    }
    h2::before { content: 'üì∏'; font-size: 30px; }
    video {
      width: 100%; border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px; border: 1px solid #ddd;
    }
    button {
      width: 100%; padding: 16px;
      background: #007bff; color: #fff;
      border: none; border-radius: 5px;
      font-size: 18px; font-weight: 600;
      cursor: pointer; transition: 0.3s;
    }
    button:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,123,255,0.3);
    }
    canvas { display: none; }
    @media (max-width:600px){
      .container { padding: 30px 25px; }
      h2 { font-size: 22px; }
      button { font-size: 16px; padding: 14px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Absensi Wajah</h2>
    <video id="video" autoplay playsinline></video>
    <button id="capture">Potret & Absen</button>
    <canvas id="canvas"></canvas>
  </div>

  <script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  const captureBtn = document.getElementById('capture');

  // ‚úÖ Aktifkan kamera
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => { video.srcObject = stream; })
    .catch(err => {
      Swal.fire({
        icon: "error",
        title: "Kamera Error",
        text: "‚ùå Kamera tidak bisa diakses! Periksa izin kamera."
      });
    });

  // ‚úÖ Tombol Potret & Absen
  captureBtn.onclick = function() {
    Swal.fire({
      title: "Sedang memproses...",
      text: "Harap tunggu sebentar",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(blob => {
      const formData = new FormData();
      formData.append("foto", blob, "capture.jpg");
      formData.append("lat", -6.200115);
      formData.append("lng", 106.816719);

      fetch("/absen", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          let badgeColor = "#28a745";
          if (data.status.toLowerCase() === "alfa") badgeColor = "#dc3545";
          else if (data.status.toLowerCase() === "izin") badgeColor = "#ffc107";
          else if (data.status.toLowerCase() === "sakit") badgeColor = "#17a2b8";

          Swal.fire({
            confirmButtonText: "üìã Lihat Absensi",
            confirmButtonColor: "#007bff",
            allowOutsideClick: false,
            html: `
              <div style="padding:20px;text-align:left;font-size:14px;color:#333;">
                <div style="font-size:42px;text-align:center;color:#007bff;">‚úÖ</div>
                <h3 style="margin:10px 0;text-align:center;">Absen Berhasil!</h3>
                <p><b>Nama:</b> ${data.nama}</p>
                <p><b>Kelas:</b> ${data.kelas}</p>
                <p><b>Jurusan:</b> ${data.jurusan}</p>
                <p><b>Status:</b> 
                  <span style="background:${badgeColor};color:#fff;padding:5px 10px;border-radius:5px;font-weight:bold;">
                    ${data.status}
                  </span>
                </p>
              </div>
            `
          }).then(() => {
            window.location.href = data.redirect;
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Wajah Tidak Dikenali üò¢",
            text: data.message || "Silakan coba lagi"
          });
        }
      })
      .catch(() => {
        Swal.fire({
          icon: "error",
          title: "Error Server",
          text: "‚ùå Gagal mengirim data absen!"
        });
      });
    }, "image/jpeg");
  };
  </script>
</body>
</html>
